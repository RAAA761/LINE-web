<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LINE</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Helvetica Neue', 'Segoe UI', sans-serif;
      background-color: #e5e5ea;
      color: #000;
    }

    #container {
      display: flex;
      height: 100vh;
    }

    #leftPane {
      width: 320px;
      background-color: #fff;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }

    #loginArea {
      padding: 16px;
      border-bottom: 1px solid #ddd;
    }

    #loginArea input {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    #loginArea button {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      margin-top: 8px;
      background-color: #0b93f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #chatButtons {
      flex: 1;
      overflow-y: auto;
    }

    .chat-button {
      display: flex;
      flex-direction: column;
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      background: #fff;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .chat-button:hover {
      background: #f5f5f7;
    }

    .chat-title {
      font-weight: bold;
      font-size: 14px;
    }

    .chat-snippet {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    #leftPane button#loadMessages {
      width: 100%;
      padding: 10px;
      border: none;
      background: #ddd;
      cursor: pointer;
    }

    #rightPaneWrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f5f5f7;
    }

    #rightPane {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      white-space: pre-wrap;
    }

    .sent-message {
      align-self: flex-end;
      background: #0b93f6;
      color: white;
      border-bottom-right-radius: 0;
    }

    .received-message {
      align-self: flex-start;
      background: #e5e5ea;
      color: black;
      border-bottom-left-radius: 0;
    }

    #sendArea {
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ccc;
    }

    #sendArea textarea {
      width: 100%;
      height: 60px;
      font-size: 14px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: vertical;
    }

    #sendArea button {
      margin-top: 8px;
      width: 100%;
      padding: 10px;
      font-size: 14px;
      background: #0b93f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #messageCount {
      display: block;
      padding: 10px;
      font-size: 13px;
      color: #555;
      background: #fafafa;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="leftPane">
      <div id="loginArea">
        <label>
          <input type="text" id="token" placeholder="AuthToken" />
          <input type="text" id="refreshtoken" placeholder="RefreshToken" />
        </label>
        <button id="login">ログイン</button>
      </div>
      <div id="chatButtons"></div>
      <button id="loadMessages" disabled>メッセージ取得</button>
      <span id="messageCount">0件</span>
    </div>

    <div id="rightPaneWrapper">
      <div id="rightPane" tabindex="0">ここにメッセージ履歴が表示されます</div>
      <div id="sendArea">
        <textarea id="message" placeholder="メッセージを入力..."></textarea>
        <button id="send" disabled>送信</button>
      </div>
    </div>
  </div>

  <script>
    const tokenInput = document.getElementById("token");
    const refreshTokenInput = document.getElementById("refreshtoken");
    const loginButton = document.getElementById("login");
    const chatButtons = document.getElementById("chatButtons");
    const sendButton = document.getElementById("send");
    const loadMessagesButton = document.getElementById("loadMessages");
    const result = document.getElementById("rightPane");
    const messageInput = document.getElementById("message");
    const messageCount = document.getElementById("messageCount");

    let selectedChatMid = null;
    let lastMessageIds = new Set();

    async function callApi(body) {
      const refreshToken = refreshTokenInput.value.trim();
      let url = "/";
      if (refreshToken) url += `?refreshToken=${encodeURIComponent(refreshToken)}`;
      if (refreshToken) body.refreshToken = refreshToken;

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();

      if (data.updatedAuthToken) tokenInput.value = data.updatedAuthToken;
      if (data.updatedRefreshToken) refreshTokenInput.value = data.updatedRefreshToken;
      return data;
    }

    loginButton.onclick = async () => {
      const token = tokenInput.value.trim();
      if (!token) return alert("AuthTokenを入力してください");

      const data = await callApi({ token, action: "squares" });
      chatButtons.innerHTML = "";
      selectedChatMid = null;
      sendButton.disabled = true;
      loadMessagesButton.disabled = true;
      result.innerHTML = "";

      if (Array.isArray(data.result)) {
        data.result.forEach(chat => {
          const div = document.createElement("div");
          div.className = "chat-button";
          div.innerHTML = `
            <div class="chat-title">${chat.name}</div>
            <div class="chat-snippet">${chat.squareChatMid.slice(0, 6)}...</div>
          `;
          div.onclick = async () => {
            selectedChatMid = chat.squareChatMid;
            sendButton.disabled = false;
            loadMessagesButton.disabled = false;
            result.innerHTML = `<div id="chatContent" style="display:flex;flex-direction:column;gap:6px;"></div>`;
            lastMessageIds.clear();
            await loadMessages(tokenInput.value.trim(), selectedChatMid, true);
          };
          chatButtons.appendChild(div);
        });
      } else {
        result.textContent = JSON.stringify(data.result, null, 2);
      }
    };

    async function loadMessages(token, chatMid, scrollToBottom = false) {
      if (!token || !chatMid) return;
      const data = await callApi({ token, action: "messages", squareChatMid: chatMid });
      if (!Array.isArray(data.events)) return;

      const chatContent = document.getElementById("chatContent");
      let count = 0;

      for (const e of data.events) {
        const msgData = e.payload?.receiveMessage?.squareMessage?.message ?? e.payload?.sendMessage?.squareMessage?.message;
        if (!msgData || lastMessageIds.has(msgData.id)) continue;

        lastMessageIds.add(msgData.id);
        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${e.type === "SEND_MESSAGE" ? "sent-message" : "received-message"}`;
        msgDiv.textContent = msgData.text || "（空メッセージ）";
        chatContent.appendChild(msgDiv);
        count++;
      }

      if (scrollToBottom) chatContent.lastElementChild?.scrollIntoView({ behavior: "smooth" });
      messageCount.textContent = `${lastMessageIds.size}件`;
    }

    sendButton.onclick = async () => {
      const token = tokenInput.value.trim();
      const text = messageInput.value.trim();
      if (!token || !selectedChatMid || !text) return alert("入力が不足しています");

      const data = await callApi({ token, action: "send", squareChatMid: selectedChatMid, text });
      if (data.message) {
        messageInput.value = "";
        await loadMessages(token, selectedChatMid, true);
      } else {
        alert("送信に失敗しました");
      }
    };

    loadMessagesButton.onclick = async () => {
      if (!selectedChatMid) return;
      await loadMessages(tokenInput.value.trim(), selectedChatMid, true);
    };

    window.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      if (params.get("token")) tokenInput.value = params.get("token");
      if (params.get("refreshToken")) refreshTokenInput.value = params.get("refreshToken");
      if (tokenInput.value) loginButton.click();
    });
  </script>
</body>
</html>
