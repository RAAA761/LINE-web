<!DOCTYPE html>  
<html lang="ja">  
<head>  
  <meta charset="UTF-8" />  
  <title>LINE OpenChat 操作UI</title>  
  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      margin: 0;
      height: 100vh;
      box-sizing: border-box;
      background: #f8f9fa;
    }

    #container {
      display: flex;
      height: 100vh;
    }

    #leftPane {
      flex: 0 0 300px;
      background: #ffffff;
      border-right: 1px solid #ccc;
      padding: 20px;
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
      overflow-y: auto;
    }

    #chatButtons {
      margin-top: 10px;
      overflow-y: auto;
      max-height: 60vh;
    }

    .chat-button {
      display: block;
      margin: 5px 0;
      padding: 10px;
      background: #eef3ff;
      border: none;
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .chat-button:hover {
      background: #dde7ff;
    }

    #rightPaneWrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f0f2f5;
    }

    #chatHeader {
      padding: 10px 20px;
      font-size: 1.1em;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      background: #fff;
    }

    #rightPane {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      display: flex;
      max-width: 75%;
      padding: 10px;
      border-radius: 16px;
      word-break: break-word;
      white-space: pre-wrap;
      position: relative;
      font-size: 0.95em;
      line-height: 1.4;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .message.right {
      align-self: flex-end;
      background: #dcf8c6;
    }

    .message.left {
      align-self: flex-start;
    }

    .message .meta {
      font-size: 0.75em;
      color: #666;
      margin-top: 4px;
      display: block;
    }

    .reply-preview {
      font-size: 0.75em;
      color: #444;
      border-left: 3px solid #ccc;
      padding-left: 6px;
      margin-bottom: 6px;
      cursor: pointer;
    }

    #sendArea {
      background: #fff;
      border-top: 1px solid #ccc;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }

    #sendArea textarea {
      width: 100%;
      height: 60px;
      font-size: 1em;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      resize: vertical;
    }

    #sendArea button {
      margin-top: 8px;
      font-size: 1em;
      padding: 10px;
      background: #4f92ff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    #sendArea button:hover {
      background: #3878db;
    }

    .profile-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
      object-fit: cover;
      vertical-align: middle;
    }

    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
  </style>
</head>  
<body>  
  <h1>LINE OpenChat 操作ページ ver0.89</h1>  
  <div id="container">  
    <div id="leftPane">  
      <div id="loginArea">  
        <label>  
          AuthToken:  
          <input type="text" id="token" placeholder="ここにAuthTokenを貼り付け" />  
          refreshToken:  
          <input type="text" id="refreshtoken" placeholder="ここにRefreshTokenを貼り付け" />  
        </label>  
        <button id="login">ログイン</button>  
      </div>  
      <div id="chatButtons" tabindex="0"></div>  
      <button id="loadMessages" disabled>過去メッセージ取得</button>  
      <span id="messageCount" style="margin-left: 8px;">0件</span>  
    </div>  

    <div id="rightPaneWrapper">
      <div id="chatHeader">選択中のOpenChatは未選択です</div>
      <div id="rightPane" tabindex="0"></div>
      <div id="sendArea">
        <label>メッセージ内容:
          <textarea id="message" placeholder="送信したい内容を入力"></textarea>
        </label>
        <button id="send" disabled>メッセージ送信</button>
      </div>
    </div>
  </div>  

<script>
const tokenInput = document.getElementById("token");
const refreshTokenInput = document.getElementById("refreshtoken");
const loginButton = document.getElementById("login");
const chatButtons = document.getElementById("chatButtons");
const messageInput = document.getElementById("message");
const sendButton = document.getElementById("send");
const loadMessagesButton = document.getElementById("loadMessages");
const result = document.getElementById("rightPane");
let selectedChatMid = null;
let lastMessageIds = new Set();

function formatDeliveredTime(deliveredTime) {
  if (!deliveredTime) return "";
  const date = new Date(Number(deliveredTime));
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  return `${hours}:${minutes}:${seconds}`;
}

async function callApi(body) {
  const refreshToken = refreshTokenInput.value.trim();
  let url = "/";
  if (refreshToken) {
    url += `?refreshToken=${encodeURIComponent(refreshToken)}`;
    body.refreshToken = refreshToken;
  }

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
  });

  const data = await res.json();
  if (data.updatedAuthToken) tokenInput.value = data.updatedAuthToken;
  if (data.updatedRefreshToken) refreshTokenInput.value = data.updatedRefreshToken;
  if (data.tokenChanged) console.log("トークンが更新されました");
  return data;
}

loginButton.onclick = async () => {
  const token = tokenInput.value.trim();
  if (!token) return alert("AuthTokenを入力してください");

  try {
    const data = await callApi({ token, action: "squares" });
    chatButtons.innerHTML = "";
    selectedChatMid = null;
    sendButton.disabled = true;
    loadMessagesButton.disabled = true;
    result.textContent = "";

    if (Array.isArray(data.result)) {
      for (const chat of data.result) {
        const btn = document.createElement("button");
        btn.className = "chat-button";
        btn.textContent = `${chat.name} (${chat.squareChatMid.slice(0, 6)}...)`;
        btn.onclick = async () => {
          document.getElementById("chatHeader").textContent = `選択中: ${chat.name}`;
          selectedChatMid = chat.squareChatMid;
          sendButton.disabled = false;
          loadMessagesButton.disabled = false;
          result.textContent = `選択中: ${chat.name}\n\n過去メッセージを取得中...`;
          lastMessageIds.clear();
          await loadMessages(tokenInput.value.trim(), selectedChatMid, true);
        };
        chatButtons.appendChild(btn);
      }
    } else {
      result.textContent = JSON.stringify(data.result, null, 2);
    }
  } catch (error) {
    console.error("ログインエラー:", error);
    alert("ログインに失敗しました");
  }
};

async function loadMessages(token, chatMid, scrollToBottom = false) {
  if (!token || !chatMid) return;

  try {
    const data = await callApi({ token, action: "messages", squareChatMid: chatMid });
    if (data.error) {
      result.textContent = `エラー: ${data.message}`;
      return;
    }

    if (!Array.isArray(data.events)) {
      result.textContent = "データが正しくありません";
      console.error("Unexpected response format:", data);
      return;
    }

    const newEvents = data.events.filter(e => {
      const msg = e.payload?.receiveMessage?.squareMessage?.message ?? e.payload?.sendMessage?.squareMessage?.message;
      return msg && !lastMessageIds.has(msg.id);
    });

    newEvents.forEach(e => {
      const msg = e.payload?.receiveMessage?.squareMessage?.message ?? e.payload?.sendMessage?.squareMessage?.message;
      if (msg?.id) lastMessageIds.add(msg.id);
    });

    if (!document.getElementById("chatContent")) {
      result.innerHTML = '<div id="chatContent" style="display:flex; flex-direction:column; gap:6px;"></div>';
    }
    const chatContent = document.getElementById("chatContent");

    for (const e of newEvents) {
      const isReceive = e.type === "RECEIVE_MESSAGE";
      const isSend = e.type === "SEND_MESSAGE";
      const msgData = e.payload?.receiveMessage?.squareMessage?.message ?? e.payload?.sendMessage?.squareMessage?.message;
      if (!msgData) continue;

      const from = msgData.from || msgData._from || "?";
      const text = msgData.text?.trim() || "";
      const id = msgData.id;
      const deliveredTime = msgData.deliveredTime;

      const profile = data.profiles?.[from];
      const displayName = profile?.displayName || from;
      const pictureStatus = profile?.pictureStatus;

      const msgDiv = document.createElement("div");
      msgDiv.style.maxWidth = "80%";
      msgDiv.style.padding = "6px 10px";
      msgDiv.style.borderRadius = "10px";
      msgDiv.style.wordBreak = "break-word";
      msgDiv.style.whiteSpace = "pre-wrap";
      msgDiv.dataset.messageId = id;

      if (profile && isReceive) {
        const headerDiv = document.createElement("div");
        headerDiv.className = "profile-header";

        if (pictureStatus) {
          const iconImg = document.createElement("img");
          iconImg.src = `https://obs.line-scdn.net/${pictureStatus}/preview`;
          iconImg.className = "profile-icon";
          iconImg.onerror = () => iconImg.style.display = "none";
          headerDiv.appendChild(iconImg);
        }

        const nameSpan = document.createElement("span");
        nameSpan.textContent = displayName;
        headerDiv.appendChild(nameSpan);
        msgDiv.appendChild(headerDiv);
      }

      if (msgData.messageRelationType === "REPLY" && msgData.relatedMessageId) {
        const replyMsgElem = chatContent.querySelector(`[data-message-id="${msgData.relatedMessageId}"]`);
        if (replyMsgElem) {
          const replyPreview = document.createElement("div");
          replyPreview.className = "reply-preview";
          replyPreview.textContent = replyMsgElem.textContent.slice(0, 30) + (replyMsgElem.textContent.length > 30 ? "..." : "");
          replyPreview.onclick = () => {
            replyMsgElem.scrollIntoView({ behavior: "smooth", block: "center" });
          };
          msgDiv.appendChild(replyPreview);
        }
      }

      if (isSend) {
        msgDiv.style.alignSelf = "flex-end";
        msgDiv.style.backgroundColor = "#DCF8C6";
        msgDiv.style.color = "#000";
      } else {
        msgDiv.style.alignSelf = "flex-start";
        msgDiv.style.backgroundColor = "#fff";
        msgDiv.style.color = "#000";
      }

      const textNode = document.createElement("div");
      textNode.textContent = text;
      msgDiv.appendChild(textNode);

      if (deliveredTime) {
        const timeDiv = document.createElement("div");
        timeDiv.className = "message-time";
        timeDiv.textContent = formatDeliveredTime(deliveredTime);
        msgDiv.appendChild(timeDiv);
      }

      chatContent.appendChild(msgDiv);
    }

    if (scrollToBottom) {
      chatContent.lastElementChild?.scrollIntoView({ behavior: "smooth" });
    }
  } catch (e) {
    result.textContent = "メッセージ取得中にエラーが発生しました";
    console.error(e);
  }
}

sendButton.onclick = async () => {
  const token = tokenInput.value.trim();
  const text = messageInput.value.trim();
  if (!token || !selectedChatMid || !text) return alert("全て入力してください");

  try {
    const data = await callApi({ token, action: "send", squareChatMid: selectedChatMid, text });
    if (data.message) {
      messageInput.value = "";
    } else if (data.error) {
      alert(`エラー: ${data.message}`);
    }
  } catch (error) {
    console.error("送信エラー:", error);
    alert("メッセージ送信に失敗しました");
  }
};

loadMessagesButton.onclick = async () => {
  if (!selectedChatMid) return alert("チャットを選択してください");
  await loadMessages(tokenInput.value.trim(), selectedChatMid, true);
};

window.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const tokenFromUrl = urlParams.get("token");
  const refreshTokenFromUrl = urlParams.get("refreshToken") || urlParams.get("refresh_token");

  if (tokenFromUrl) tokenInput.value = tokenFromUrl;
  if (refreshTokenFromUrl) refreshTokenInput.value = refreshTokenFromUrl;
  if (tokenFromUrl) loginButton.click();
});

let pollingInterval = null;

function isScrolledToBottom() {
  const el = document.getElementById("rightPane");
  return el.scrollHeight - el.scrollTop - el.clientHeight < 5;
}

function startPolling() {
  if (pollingInterval) clearInterval(pollingInterval);
  pollingInterval = setInterval(() => {
    const token = tokenInput.value.trim();
    if (token && selectedChatMid) {
      const autoScroll = isScrolledToBottom();
      loadMessages(token, selectedChatMid, autoScroll);
    }
  }, 1000);
}

startPolling();
</script>
</body>  
</html>