<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LINE OpenChat Êìç‰ΩúUI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif;
      background: #2c3e50;
      color: #ffffff;
      height: 100vh;
      overflow: hidden;
    }

    /* „Éà„ÉÉ„Éó„Éê„Éº */
    .top-bar {
      background: #34495e;
      height: 40px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid #3e4f66;
    }

    .top-bar .tabs {
      display: flex;
      gap: 24px;
    }

    .top-bar .tab {
      color: #95a5a6;
      font-size: 14px;
      cursor: pointer;
      padding: 8px 0;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .top-bar .tab.active {
      color: #00c73c;
      border-bottom-color: #00c73c;
    }

    .top-bar .tab:hover {
      color: #ffffff;
    }

    /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
    .main-container {
      display: flex;
      height: calc(100vh - 40px);
    }

    /* Â∑¶„Çµ„Ç§„Éâ„Éê„Éº */
    .sidebar {
      width: 320px;
      background: #34495e;
      border-right: 1px solid #3e4f66;
      display: flex;
      flex-direction: column;
    }

    /* Ê§úÁ¥¢„Éê„Éº */
    .search-bar {
      padding: 12px 16px;
      border-bottom: 1px solid #3e4f66;
    }

    .search-input {
      width: 100%;
      background: #2c3e50;
      border: 1px solid #3e4f66;
      border-radius: 20px;
      padding: 8px 16px;
      color: #ffffff;
      font-size: 14px;
    }

    .search-input::placeholder {
      color: #7f8c8d;
    }

    .search-input:focus {
      outline: none;
      border-color: #00c73c;
    }

    /* „ÉÅ„É£„ÉÉ„Éà„É™„Çπ„Éà */
    .chat-list {
      flex: 1;
      overflow-y: auto;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #3e4f66;
      transition: background 0.2s;
    }

    .chat-item:hover {
      background: #3e4f66;
    }

    .chat-item.active {
      background: #2c3e50;
    }

    .chat-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #7f8c8d;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #ffffff;
      flex-shrink: 0;
    }

    .chat-info {
      flex: 1;
      min-width: 0;
    }

    .chat-name {
      font-size: 14px;
      font-weight: 500;
      color: #ffffff;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-preview {
      font-size: 12px;
      color: #7f8c8d;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-left: 8px;
    }

    .chat-time {
      font-size: 11px;
      color: #7f8c8d;
      margin-bottom: 4px;
    }

    .chat-badge {
      background: #00c73c;
      color: #ffffff;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      min-width: 18px;
      text-align: center;
    }

    /* „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #2c3e50;
    }

    /* „ÉÅ„É£„ÉÉ„Éà„Éò„ÉÉ„ÉÄ„Éº */
    .chat-header {
      background: #34495e;
      padding: 12px 16px;
      border-bottom: 1px solid #3e4f66;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
    }

    .chat-header-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #7f8c8d;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #ffffff;
    }

    .chat-header-info h3 {
      font-size: 14px;
      font-weight: 500;
      color: #ffffff;
      margin-bottom: 2px;
    }

    .chat-header-info p {
      font-size: 12px;
      color: #7f8c8d;
    }

    .chat-header-actions {
      display: flex;
      gap: 8px;
    }

    .header-button {
      background: none;
      border: none;
      color: #7f8c8d;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .header-button:hover {
      color: #ffffff;
      background: #3e4f66;
    }

    /* „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #2c3e50;
    }

    .message {
      margin-bottom: 16px;
      display: flex;
      align-items: flex-end;
    }

    .message.sent {
      justify-content: flex-end;
    }

    .message.received {
      justify-content: flex-start;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #7f8c8d;
      margin-right: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #ffffff;
      flex-shrink: 0;
    }

    .message.sent .message-avatar {
      display: none;
    }

    .message-content {
      max-width: 60%;
      display: flex;
      flex-direction: column;
    }

    .message-sender {
      font-size: 11px;
      color: #7f8c8d;
      margin-bottom: 4px;
      margin-left: 8px;
    }

    .message.sent .message-sender {
      display: none;
    }

    .message-bubble {
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
      position: relative;
    }

    .message.received .message-bubble {
      background: #34495e;
      color: #ffffff;
      border-bottom-left-radius: 4px;
    }

    .message.sent .message-bubble {
      background: #00c73c;
      color: #ffffff;
      border-bottom-right-radius: 4px;
    }

    .message-time {
      font-size: 10px;
      color: #7f8c8d;
      margin-top: 4px;
      text-align: right;
    }

    .message.received .message-time {
      text-align: left;
      margin-left: 8px;
    }

    /* ÂÖ•Âäõ„Ç®„É™„Ç¢ */
    .input-area {
      background: #34495e;
      border-top: 1px solid #3e4f66;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input-buttons {
      display: flex;
      gap: 8px;
    }

    .input-button {
      background: none;
      border: none;
      color: #7f8c8d;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .input-button:hover {
      color: #ffffff;
      background: #3e4f66;
    }

    .message-input {
      flex: 1;
      background: #2c3e50;
      border: 1px solid #3e4f66;
      border-radius: 20px;
      padding: 10px 16px;
      color: #ffffff;
      font-size: 14px;
      resize: none;
      min-height: 20px;
      max-height: 100px;
    }

    .message-input::placeholder {
      color: #7f8c8d;
    }

    .message-input:focus {
      outline: none;
      border-color: #00c73c;
    }

    .send-button {
      background: #00c73c;
      border: none;
      color: #ffffff;
      font-size: 16px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 50%;
      transition: all 0.2s;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-button:hover {
      background: #00a82d;
    }

    .send-button:disabled {
      background: #7f8c8d;
      cursor: not-allowed;
    }

    /* „É≠„Ç∞„Ç§„É≥„É¢„Éº„ÉÄ„É´ */
    .login-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .login-form {
      background: #34495e;
      padding: 32px;
      border-radius: 12px;
      width: 400px;
      max-width: 90%;
    }

    .login-form h2 {
      color: #ffffff;
      margin-bottom: 24px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      color: #bdc3c7;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      background: #2c3e50;
      border: 1px solid #3e4f66;
      border-radius: 8px;
      padding: 12px;
      color: #ffffff;
      font-size: 14px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #00c73c;
    }

    .login-button {
      width: 100%;
      background: #00c73c;
      border: none;
      color: #ffffff;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .login-button:hover {
      background: #00a82d;
    }

    /* „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº */
    .placeholder {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7f8c8d;
      font-size: 16px;
    }

    /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #2c3e50;
    }

    ::-webkit-scrollbar-thumb {
      background: #7f8c8d;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #95a5a6;
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #7f8c8d;
      padding: 40px;
      text-align: center;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: #bdc3c7;
    }

    .empty-state p {
      font-size: 14px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <!-- „É≠„Ç∞„Ç§„É≥„É¢„Éº„ÉÄ„É´ -->
  <div id="loginModal" class="login-modal">
    <div class="login-form">
      <h2>LINE OpenChat „Å´„É≠„Ç∞„Ç§„É≥</h2>
      <div class="form-group">
        <label for="authToken">AuthToken</label>
        <input type="text" id="authToken" placeholder="AuthToken„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" />
      </div>
      <div class="form-group">
        <label for="refreshToken">RefreshToken</label>
        <input type="text" id="refreshToken" placeholder="RefreshToken„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ" />
      </div>
      <button id="loginButton" class="login-button">„É≠„Ç∞„Ç§„É≥</button>
    </div>
  </div>

  <!-- „Éà„ÉÉ„Éó„Éê„Éº -->
  <div class="top-bar">
    <div class="tabs">
      <div class="tab">„Åô„Åπ„Å¶</div>
      <div class="tab active">Âèã„Å†„Å°</div>
      <div class="tab">„Ç∞„É´„Éº„Éó</div>
      <div class="tab">ÂÖ¨Âºè„Ç¢„Ç´„Ç¶„É≥„Éà</div>
    </div>
  </div>

  <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä -->
  <div class="main-container">
    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <div class="sidebar">
      <!-- Ê§úÁ¥¢„Éê„Éº -->
      <div class="search-bar">
        <input type="text" class="search-input" placeholder="„Éà„Éº„ÇØ„É´„Éº„É†Ê§úÁ¥¢" />
      </div>

      <!-- „ÉÅ„É£„ÉÉ„Éà„É™„Çπ„Éà -->
      <div id="chatList" class="chat-list">
        <!-- „ÉÅ„É£„ÉÉ„Éà„Ç¢„Ç§„ÉÜ„É†„ÅØJS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
      </div>
    </div>

    <!-- „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ -->
    <div class="chat-area">
      <!-- „ÉÅ„É£„ÉÉ„Éà„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆË°®Á§∫ -->
      <div id="emptyState" class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <h3>„Éà„Éº„ÇØ„É´„Éº„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
        <p>Â∑¶„ÅÆ„É™„Çπ„Éà„Åã„Çâ„Éà„Éº„ÇØ„É´„Éº„É†„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅ<br>„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</p>
      </div>

      <!-- „ÉÅ„É£„ÉÉ„Éà„Éò„ÉÉ„ÉÄ„Éº -->
      <div id="chatHeader" class="chat-header" style="display: none;">
        <div class="chat-header-left">
          <div class="chat-header-avatar">üó®</div>
          <div class="chat-header-info">
            <h3 id="chatHeaderName">„Éà„Éº„ÇØ„É´„Éº„É†Âêç</h3>
            <p id="chatHeaderStatus">„Ç™„É≥„É©„Ç§„É≥</p>
          </div>
        </div>
        <div class="chat-header-actions">
          <button class="header-button" title="ÈÄöË©±">üìû</button>
          <button class="header-button" title="„Éì„Éá„Ç™ÈÄöË©±">üìπ</button>
          <button class="header-button" title="„É°„Éã„É•„Éº">‚ãØ</button>
        </div>
      </div>

      <!-- „É°„ÉÉ„Çª„Éº„Ç∏„Ç≥„É≥„ÉÜ„Éä -->
      <div id="messagesContainer" class="messages-container" style="display: none;">
        <!-- „É°„ÉÉ„Çª„Éº„Ç∏„ÅØJS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
      </div>

      <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
      <div id="inputArea" class="input-area" style="display: none;">
        <div class="input-buttons">
          <button class="input-button" title="„Éï„Ç°„Ç§„É´Ê∑ª‰ªò">üìé</button>
          <button class="input-button" title="ÂÜôÁúü„ÉªÂãïÁîª">üì∑</button>
        </div>
        <textarea id="messageInput" class="message-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ" rows="1"></textarea>
        <button id="sendButton" class="send-button" disabled>‚û§</button>
      </div>
    </div>
  </div>

  <script>
    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    let authToken = '';
    let refreshToken = '';
    let selectedChatMid = null;
    let selectedChatName = '';
    let lastMessageIds = new Set();
    let pollingInterval = null;
    let chats = [];

    // DOMË¶ÅÁ¥†
    const loginModal = document.getElementById('loginModal');
    const authTokenInput = document.getElementById('authToken');
    const refreshTokenInput = document.getElementById('refreshToken');
    const loginButton = document.getElementById('loginButton');
    const chatList = document.getElementById('chatList');
    const emptyState = document.getElementById('emptyState');
    const chatHeader = document.getElementById('chatHeader');
    const chatHeaderName = document.getElementById('chatHeaderName');
    const messagesContainer = document.getElementById('messagesContainer');
    const inputArea = document.getElementById('inputArea');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(Number(timestamp));
      const now = new Date();
      const diff = now - date;
      
      if (diff < 24 * 60 * 60 * 1000) {
        // 24ÊôÇÈñì‰ª•ÂÜÖ„ÅØÊôÇ:ÂàÜ„ÅßË°®Á§∫
        return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      } else if (diff < 7 * 24 * 60 * 60 * 1000) {
        // 1ÈÄ±Èñì‰ª•ÂÜÖ„ÅØÊõúÊó•„ÅßË°®Á§∫
        const days = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
        return days[date.getDay()];
      } else {
        // „Åù„Çå‰ª•Â§ñ„ÅØÊúà/Êó•„ÅßË°®Á§∫
        return `${date.getMonth() + 1}/${date.getDate()}`;
      }
    }

    function getInitials(name) {
      if (!name) return '?';
      return name.charAt(0).toUpperCase();
    }

    // APIÂëº„Å≥Âá∫„Åó
    async function callApi(body) {
      let url = '/';
      if (refreshToken) {
        url += `?refreshToken=${encodeURIComponent(refreshToken)}`;
        body.refreshToken = refreshToken;
      }

      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const data = await response.json();
      
      if (data.updatedAuthToken) {
        authToken = data.updatedAuthToken;
        authTokenInput.value = authToken;
      }
      if (data.updatedRefreshToken) {
        refreshToken = data.updatedRefreshToken;
        refreshTokenInput.value = refreshToken;
      }

      return data;
    }

    // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
    async function login() {
      const token = authTokenInput.value.trim();
      if (!token) {
        alert('AuthToken„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }

      try {
        loginButton.textContent = '„É≠„Ç∞„Ç§„É≥‰∏≠...';
        loginButton.disabled = true;

        const data = await callApi({ 
          token, 
          action: 'squares',
          refreshToken: refreshTokenInput.value.trim()
        });

        if (data.error) {
          throw new Error(data.message || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }

        authToken = token;
        refreshToken = refreshTokenInput.value.trim();
        chats = data.result || [];

        // „É≠„Ç∞„Ç§„É≥„É¢„Éº„ÉÄ„É´„ÇíÈùûË°®Á§∫
        loginModal.style.display = 'none';

        // „ÉÅ„É£„ÉÉ„Éà„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        updateChatList();

        // „Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
        startPolling();

      } catch (error) {
        console.error('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
        alert(error.message || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      } finally {
        loginButton.textContent = '„É≠„Ç∞„Ç§„É≥';
        loginButton.disabled = false;
      }
    }

    // „ÉÅ„É£„ÉÉ„Éà„É™„Çπ„ÉàÊõ¥Êñ∞
    function updateChatList() {
      chatList.innerHTML = '';

      chats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.onclick = () => selectChat(chat);

        chatItem.innerHTML = `
          <div class="chat-avatar">${getInitials(chat.name)}</div>
          <div class="chat-info">
            <div class="chat-name">${chat.name}</div>
            <div class="chat-preview">„Çø„ÉÉ„Éó„Åó„Å¶„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁ¢∫Ë™ç</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">‰ªäÊó•</div>
          </div>
        `;

        chatList.appendChild(chatItem);
      });
    }

    // „ÉÅ„É£„ÉÉ„ÉàÈÅ∏Êäû
    async function selectChat(chat) {
      // Ââç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
      });

      // Êñ∞„Åó„ÅÑÈÅ∏Êäû„ÇíË®≠ÂÆö
      event.currentTarget.classList.add('active');
      selectedChatMid = chat.squareChatMid;
      selectedChatName = chat.name;

      // UIÊõ¥Êñ∞
      emptyState.style.display = 'none';
      chatHeader.style.display = 'flex';
      messagesContainer.style.display = 'block';
      inputArea.style.display = 'flex';

      chatHeaderName.textContent = chat.name;
      messagesContainer.innerHTML = '';
      lastMessageIds.clear();

      // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
      updateSendButton();

      // „É°„ÉÉ„Çª„Éº„Ç∏ÂèñÂæó
      await loadMessages(true);
    }

    // „É°„ÉÉ„Çª„Éº„Ç∏Ë™≠„ÅøËæº„Åø
    async function loadMessages(scrollToBottom = false) {
      if (!authToken || !selectedChatMid) return;

      try {
        const data = await callApi({
          token: authToken,
          action: 'messages',
          squareChatMid: selectedChatMid
        });

        if (data.error) {
          console.error('„É°„ÉÉ„Çª„Éº„Ç∏ÂèñÂæó„Ç®„É©„Éº:', data.message);
          return;
        }

        if (!Array.isArray(data.events)) {
          console.error('‰∏çÊ≠£„Å™„Éá„Éº„ÇøÂΩ¢Âºè:', data);
          return;
        }

        // Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Åø„Éï„Ç£„É´„Çø
        const newEvents = data.events.filter(event => {
          const message = event.payload?.receiveMessage?.squareMessage?.message || 
                         event.payload?.sendMessage?.squareMessage?.message;
          return message && !lastMessageIds.has(message.id);
        });

        // „É°„ÉÉ„Çª„Éº„Ç∏ID„ÇíË®òÈå≤
        newEvents.forEach(event => {
          const message = event.payload?.receiveMessage?.squareMessage?.message || 
                         event.payload?.sendMessage?.squareMessage?.message;
          if (message?.id) {
            lastMessageIds.add(message.id);
          }
        });

        // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        newEvents.forEach(event => {
          displayMessage(event, data.profiles);
        });

        if (scrollToBottom && newEvents.length > 0) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

      } catch (error) {
        console.error('„É°„ÉÉ„Çª„Éº„Ç∏ÂèñÂæó„Ç®„É©„Éº:', error);
      }
    }

    // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
    function displayMessage(event, profiles) {
      const isReceived = event.type === 'RECEIVE_MESSAGE';
      const message = event.payload?.receiveMessage?.squareMessage?.message || 
                     event.payload?.sendMessage?.squareMessage?.message;

      if (!message) return;

      const messageElement = document.createElement('div');
      messageElement.className = `message ${isReceived ? 'received' : 'sent'}`;

      const from = message.from || message._from;
      const profile = profiles?.[from];
      const displayName = profile?.displayName || from || 'Unknown';
      const text = message.text?.trim() || '';
      const time = formatTime(message.deliveredTime);

      let messageHTML = '';

      if (isReceived) {
        messageHTML = `
          <div class="message-avatar">${getInitials(displayName)}</div>
          <div class="message-content">
            <div class="message-sender">${displayName}</div>
            <div class="message-bubble">${text}</div>
            <div class="message-time">${time}</div>
          </div>
        `;
      } else {
        messageHTML = `
          <div class="message-content">
            <div class="message-bubble">${text}</div>
            <div class="message-time">${time}</div>
          </div>
        `;
      }

      messageElement.innerHTML = messageHTML;
      messagesContainer.appendChild(messageElement);
    }

    // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !authToken || !selectedChatMid) return;

      try {
        sendButton.disabled = true;
        sendButton.textContent = '‚è≥';

        const data = await callApi({
          token: authToken,
          action: 'send',
          squareChatMid: selectedChatMid,
          text: text
        });

        if (data.error) {
          throw new Error(data.message || '„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }

        messageInput.value = '';
        updateSendButton();

        // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø
        setTimeout(() => loadMessages(true), 500);

      } catch (error) {
        console.error('ÈÄÅ‰ø°„Ç®„É©„Éº:', error);
        alert(error.message || '„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      } finally {
        sendButton.disabled = false;
        sendButton.textContent = '‚û§';
      }
    }

    // ÈÄÅ‰ø°„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
    function updateSendButton() {
      const hasText = messageInput.value.trim().length > 0;
      const hasChat = selectedChatMid !== null;
      sendButton.disabled = !hasText || !hasChat;
    }

    // „Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
    function startPolling() {
      if (pollingInterval) clearInterval(pollingInterval);
      
      pollingInterval = setInterval(() => {
        if (selectedChatMid && authToken) {
          const wasAtBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 50;
          loadMessages(wasAtBottom);
        }
      }, 2000);
    }

    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
    loginButton.addEventListener('click', login);
    sendButton.addEventListener('click', sendMessage);

    messageInput.addEventListener('input', updateSendButton);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ÂàùÊúüÂåñ
    window.addEventListener('DOMContentLoaded', () => {
      // URL„Éë„É©„É°„Éº„Çø„Åã„Çâ„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('token');
      const refreshTokenFromUrl = urlParams.get('refreshToken') || urlParams.get('refresh_token');

      if (tokenFromUrl) {
        authTokenInput.value = tokenFromUrl;
      }
      if (refreshTokenFromUrl) {
        refreshTokenInput.value = refreshTokenFromUrl;
      }

      // „Éà„Éº„ÇØ„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØËá™Âãï„É≠„Ç∞„Ç§„É≥
      if (tokenFromUrl) {
        login();
      }
    });
  </script>
</body>
</html>