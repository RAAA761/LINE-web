<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LINE風チャットUI</title>
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", sans-serif;
      background-color: #EDEDED;
    }
    #container {
      display: flex;
      height: 100vh;
    }
    #leftPane {
      width: 280px;
      background: #F7F7F7;
      border-right: 1px solid #D3D3D3;
      display: flex;
      flex-direction: column;
    }
    #chatButtons {
      flex: 1;
      overflow-y: auto;
    }
    .chat-button {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      background-color: #F7F7F7;
    }
    .chat-button:hover {
      background-color: #E0E0E0;
    }
    .chat-button img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
    }
    .chat-button span {
      font-size: 14px;
      color: #333;
    }
    #rightPaneWrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #EDEDED;
    }
    #chatHeader {
      height: 50px;
      line-height: 50px;
      padding: 0 20px;
      background-color: #FFFFFF;
      border-bottom: 1px solid #ccc;
      font-weight: bold;
      font-size: 15px;
    }
    #rightPane {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 18px;
      position: relative;
      font-size: 14px;
      line-height: 1.4;
      word-break: break-word;
      display: inline-block;
    }
    .left {
      align-self: flex-start;
      background: #FFFFFF;
      border: 1px solid #DDD;
    }
    .right {
      align-self: flex-end;
      background: #A8DCB8;
      color: #000;
    }
    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .profile-header img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .profile-header span {
      font-size: 13px;
      color: #555;
    }
    #sendArea {
      padding: 12px;
      background: #FFFFFF;
      border-top: 1px solid #CCC;
      display: flex;
      align-items: center;
    }
    #message {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #CCC;
      border-radius: 20px;
      resize: none;
      height: 40px;
    }
    #send {
      margin-left: 10px;
      padding: 10px 16px;
      border: none;
      background-color: #06C755;
      color: white;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
    }
    #send:disabled {
      background-color: #A5D6AC;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="leftPane">
      <input type="text" id="token" placeholder="AuthToken" style="margin:10px; padding:6px; width:90%;">
      <input type="text" id="refreshtoken" placeholder="RefreshToken" style="margin:10px; padding:6px; width:90%;">
      <button id="login" style="margin: 0 10px 10px 10px; padding: 6px;">ログイン</button>
      <div id="chatButtons"></div>
    </div>
    <div id="rightPaneWrapper">
      <div id="chatHeader">トークを選択</div>
      <div id="rightPane"></div>
      <div id="sendArea">
        <textarea id="message" placeholder="メッセージを入力"></textarea>
        <button id="send" disabled>送信</button>
      </div>
    </div>
  </div>
<script>
const tokenInput = document.getElementById("token");
const refreshTokenInput = document.getElementById("refreshtoken");
const loginButton = document.getElementById("login");
const chatButtons = document.getElementById("chatButtons");
const messageInput = document.getElementById("message");
const sendButton = document.getElementById("send");
const rightPane = document.getElementById("rightPane");
const chatHeader = document.getElementById("chatHeader");

let currentChat = null;
let chats = [];

loginButton.onclick = async () => {
  const token = tokenInput.value.trim();
  const refresh = refreshTokenInput.value.trim();
  if (!token) return alert("AuthTokenを入力してください");
  const res = await fetch("/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token, refreshToken: refresh, action: "squares" })
  });
  const data = await res.json();
  chats = data.result;
  chatButtons.innerHTML = "";
  chats.forEach(chat => {
    const btn = document.createElement("div");
    btn.className = "chat-button";
    btn.innerHTML = `<img src='https://placekitten.com/40/40'><span>${chat.name}</span>`;
    btn.onclick = async () => {
      chatHeader.textContent = chat.name;
      currentChat = chat;
      rightPane.innerHTML = "読み込み中...";
      const msgRes = await fetch("/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, action: "messages", squareChatMid: chat.squareChatMid })
      });
      const msgData = await msgRes.json();
      rightPane.innerHTML = "";
      for (const e of msgData.events || []) {
        const msg = e.payload?.receiveMessage?.squareMessage?.message || e.payload?.sendMessage?.squareMessage?.message;
        if (!msg) continue;
        const div = document.createElement("div");
        div.className = e.type === "SEND_MESSAGE" ? "message right" : "message left";
        div.textContent = msg.text;
        rightPane.appendChild(div);
      }
      sendButton.disabled = false;
    };
    chatButtons.appendChild(btn);
  });
};

sendButton.onclick = async () => {
  const token = tokenInput.value.trim();
  const text = messageInput.value.trim();
  if (!token || !currentChat || !text) return;
  await fetch("/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token, action: "send", squareChatMid: currentChat.squareChatMid, text })
  });
  messageInput.value = "";
};
</script>
</body>
</html>
